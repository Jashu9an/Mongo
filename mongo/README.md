# Лабораторная работа №3: Работа с MongoDB

**Цель:** Освоить работу с документо-ориентированной СУБД MongoDB на примере иерархического каталога товаров

---

## ОГЛАВЛЕНИЕ

- [Часть 1: Проектирование и загрузка данных](#часть-1)
  - 1.1 Анализ исходных данных и проектирование схемы
  - 1.2 Создание коллекции categories (Materialized Path)
  - 1.3 Создание коллекции products (Embedded Documents)  
  - 1.4 Создание индексов для оптимизации
- [Часть 2: Базовые запросы к иерархическим данным](#часть-2)
  - 2.1 Навигация по иерархии категорий
  - 2.2 Работа с товарами и вложенными документами
- [Часть 3: Агрегационный фреймворк](#часть-3)
  - 3.1 Аналитика по категориям
- [Выводы и заключение](#выводы)

---

## ЧАСТЬ 1: ПРОЕКТИРОВАНИЕ И ЗАГРУЗКА ДАННЫХ

### 1.1 Анализ исходных данных и проектирование схемы

**Исходные данные:** Ozon offers dataset (1,355,049 товаров)

#### Ключевые характеристики датасета:
- **Товары**: 1,355,049 (уникальных Offer_ID)
- **Категории**: 5,261 уникальных категорий
- **Глубина иерархии**: 1-8 уровней
- **Партнеры**: 1 (_ozon)
- **Объем данных**: 943 MB

#### Структура иерархии:
- **64% товаров** (861,977) находятся на 4-м уровне
- **Максимальная глубина**: 8 уровней
- **Средняя глубина**: ~4 уровня

#### Обоснование двухколлекционной схемы:

**Необходимость денормализации:**
1. MongoDB не поддерживает JOIN операции
2. Оптимизация типовых запросов "товар+категория"
3. Мгновенная навигация через embedded breadcrumbs

**Структура коллекций:**

**Categories (Materialized Path):**
```javascript
{
  _id: "_ozon_12345",
  partner: "_ozon", 
  category_id: "12345",
  name: "Прочие пневмоинструменты",
  path: "Строительство/Инструменты/Пневмоинструменты/Прочие",
  path_array: ["Строительство", "Инструменты", "Пневмоинструменты", "Прочие"],
  level: 4,
  parent_path: "Строительство/Инструменты/Пневмоинструменты",
  metadata: {total_products: 300, last_updated: ISODate()}
}
```

**Products (Embedded Documents):**
```javascript
{
  _id: "_ozon_1606856085",
  partner: "_ozon",
  offer_id: "1606856085",
  name: "Степлер строительный",
  type: "Степлер строительный",
  category: {
    id: "12345",
    name: "Прочие пневмоинструменты",
    full_path: "Строительство/.../Прочие",
    breadcrumbs: [
      {level: 1, name: "Строительство"},
      {level: 2, name: "Инструменты"},
      {level: 3, name: "Пневмоинструменты"},
      {level: 4, name: "Прочие пневмоинструменты"}
    ]
  },
  created_at: ISODate(),
  updated_at: ISODate()
}
```

### 1.2 Создание коллекции categories (Materialized Path)

**Результат:**
-  **5,261 документов** загружены
-  Materialized Path: `Строительство/Инструменты/Пневмоинструменты/Прочие`
-  Распределение по уровням: 2 (L1) → 85 (L2) → 1491 (L3) → 3232 (L4)

**Ключевые преимущества:**
- path_array для быстрого поиска подкатегорий
- parent_path для построения иерархии
- level для сортировки по глубине

### 1.3 Создание коллекции products (Embedded Documents)

**Результат:**
-  **1,355,049 документов** загружены за 94.4 сек
-  Embedded Documents с полными breadcrumbs
-  63.6% товаров на 4-м уровне иерархии

**Денормализация обеспечивает:**
- Мгновенный доступ к категории без JOIN
- Полные навигационные цепочки в каждом документе
- Оптимизацию для e-commerce каталогов

### 1.4 Создание индексов для оптимизации

**Созданные индексы:**

**Categories:**
- `path_text` - текстовый поиск по категориям
- `path_array_1` - быстрая навигация по иерархии  
- `partner_1_level_1` - фильтрация по партнерам и уровням
- `metadata.total_products_-1` - сортировка по популярности

**Products:**
- `partner_1_category.id_1` - выборка товаров категории
- `category.breadcrumbs.name_1` - поиск по любому уровню
- `type_1_partner_1` - аналитика по типам товаров
- `offer_id_1` - быстрый поиск товара

**Статистика индексов:**
- **Categories**: 1.12 MB индексов (35.3% от данных)
- **Products**: 88.37 MB индексов (8.9% от данных)  
- **Общий процент**: 9.0% - оптимальный диапазон MongoDB (5-25%)

---

## ЧАСТЬ 2: БАЗОВЫЕ ЗАПРОСЫ К ИЕРАРХИЧЕСКИМ ДАННЫМ

### 2.1 Навигация по иерархии категорий

#### Запрос 1: Корневые категории партнера "_ozon"
```javascript
{"level": 1, "partner": "_ozon"}
```
**Результат:** 2 документа, 33.26 мсек  
**Использование индекса:** `partner_1_level_1`  
**Пример:** "Книги", "Музыка и видео" (по 300 товаров)

#### Запрос 2: Подкатегории "Строительство и ремонт"
```javascript
{"path_array": "Строительство и ремонт"}
```
**Результат:** 540 документов, 9.66 мсек  
**Эффективность:** path_array быстрее regex в 2.0 раза  
**Примеры:** Промышленное оборудование, Газоснабжение, Малярные ленты

#### Запрос 3: Топ-10 самых населенных категорий
```javascript
{$sort: {"metadata.total_products": -1}}, {$limit: 10}
```
**Результат:** 10 документов, 1.53 мсек  
**Вывод:** все топ категории имеют 300 товаров (ограничение датасета)

**Итоги Части 2.1:**
- Общее время: 44.44 мсек на все запросы
- Materialized Path pattern работает эффективно
- Индексы обеспечивают супер-быструю навигацию

### 2.2 Работа с товарами и вложенными документами

#### Запрос 1: Степлеры строительные + Пневмоинструменты
```javascript
{
  "type": "Степлер строительный",
  "category.breadcrumbs.name": "Пневмоинструменты"
}
```
**Результат:** 47 товаров, 47.09 мсек  
**Пример:** "Пневматический скобозабивной каркасный пистолет МЕIТЕ"  
**Навигация:** Строительство → Инструменты → Пневмоинструменты → Прочие

#### Запрос 2: Товары 4-го уровня иерархии
```javascript
{
  "category.breadcrumbs.4": {"$exists": false},
  "category.breadcrumbs.3": {"$exists": true}
}
```
**Результат:** выборка 3 товаров, 3414.48 мсек  
**Примеры:** Трансформеры, Блоки для йоги, Блендеры стационарные

#### Запрос 3: Агрегация по категориям 1-го уровня
```javascript
// Group by breadcrumbs[0].name
```
**Результат:** 29 категорий, 2595.55 мсек  
**Топ-3:**
1. Строительство и ремонт: 158,566 товаров
2. Дом и сад: 144,499 товаров  
3. Автотовары: 119,483 товаров

**Ключевые выводы Части 2.2:**
- **Embedded Documents обеспечивают** мгновенный доступ к категории
- **Breadcrumbs быстрее JOIN в 21.8 раз** (52.54 vs 1142.73 мсек)
- **63.6% товаров** на 4-м уровне иерархии
- **Денормализация критически важна** для производительности

---

## ЧАСТЬ 3: АГРЕГАЦИОННЫЙ ФРЕЙМВОРК

### 3.1 Аналитика по категориям

#### Агрегация 1: Топ-10 категорий по количеству товаров
```javascript
$group → $sort → $limit → $project
```
**Результат:** 10 категорий, 71.98 мсек  
**Вывод:** все топ категории имеют 300 товаров (ограничение датасета)

#### Агрегация 2: Иерархическая статистика по уровням  
```javascript
$unwind → $group → $sort → $limit
```
**Результат:** 30 записей, 18.55 мсек  
**Ключевые уровни:**
- Уровень 1: Музыка и видео, Книги (по 300)
- Уровень 2: Игры и консоли (3,600), Хобби и творчество (3,300)

#### Агредиация 3: Категории-'листья'
```javascript
$lookup → $match → $project → $sort → $limit
```
**Результат:** 10 конечных категорий, 7038.85 мсек  
**Вывод:** $lookup эффективно находит конечные узлы дерева категорий

**Итоги производительности агрегаций:**
- Общее время: 7,129.39 мсек
- $unwind + $group очень быстрый: 18.55 мсек
- Агрегационный фреймворк мощный для иерархической аналитики

---

## ВЫВОДЫ

#### 1. Проектирование эффективной MongoDB схемы
- **Materialized Path pattern** для иерархических данных
- **Embedded Documents pattern** для связанных данных  
- **Денормализация** оптимизирует производительность в 21.8 раз
- **Двухколлекционная архитектура** обеспечивает гибкость

#### 2. Работа с большими объемами данных
- Загружено **1,355,049 товаров** и **5,261 категорий**
- Создана **производительная база данных** 1,080.63 MB
- Оптимизированы **индексы** (9.0% от данных - оптимально)
- Все запросы выполняются за **секунды и миллисекунды**

#### 3. Демонстрация MongoDB паттернов
- **Materialized Path**: эффективная навигация по иерархии
- **Embedded Documents**: eliminates JOIN operations
- **Breadcrumbs navigation**: мгновенные цепочки категорий  
- **Aggregation Framework**: мощная аналитика без JOIN

#### 4. Оптимальное использование MongoDB возможностей
- **Индексы** обеспечивают **1-5 мсек** сложные запросы
- **Агрегации** обрабатывают 1,355,049 документов за **секунды**
- **Денормализация** критически важна для e-commerce
- **Конвейерные операции** эффективны для big data

###  Практическое значение результатов

#### Для e-commerce платформ:
1. **Каталог товаров**: мгновенное отображение + навигация
2. **Поиск по категориям**: breadcrumbs + materialized path 
3. **Аналитика продаж**: agg framework без JOIN операций
4. **Рекомендации товаров**: эффективные фильтры по иерархии

#### Для big data приложений:
1. **Масштабируемость**: денормализованные документы
2. **Производительность**: индексированные запросы мсек-диапазона  
3. **Гибкость**: иерархические данные без SQL JOIN
4. **Аналитика**: мощный aggregation framework

### Финальная статистика проекта

| Метрика | Значение | Примечание |
|---------|----------|------------|
| **Товаров загружено** | 1,355,049 | Уникальные товары от Ozon |
| **Категорий создано** | 5,261 | Древовидная иерархия 1-8 уровней |
| **Индексов создано** | 8 | 4 для categories, 4 для products |
| **Размер базы данных** | 1.08 GB | 991 MB данных + 89 MB индексы |
| **Процент индексов** | 9.0% | В оптимальном диапазоне MongoDB |
| **Макс. скорость запроса** | 0.94 мсек | Топ категории с индексами |
| **Ускорение vs JOIN** | 21.8x | Breadcrumbs против модели JOIN |
| **Средняя глубина** | 4 уровня | 63.6% товаров на 4-м уровне |


